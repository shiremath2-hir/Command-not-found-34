<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Vision + Navigation Assistant</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,.3);
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 28px;
  text-align: center;
}

.header h1 {
  font-size: 2rem;
  margin-bottom: 8px;
}

.content {
  padding: 24px;
}

.controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  justify-content: center;
}

.btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 999px;
  font-size: 1rem;
  cursor: pointer;
  transition: transform .2s;
}

.btn:hover {
  transform: translateY(-2px);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn.success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.btn.danger {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}

.input-group {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.input-group input {
  flex: 1;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
}

.media-container {
  position: relative;
  max-width: 800px;
  margin: 0 auto 20px;
}

video, canvas {
  width: 100%;
  border: 3px solid #667eea;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.2);
  display: block;
}

canvas {
  display: none;
}

#desc {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px;
  border-radius: 12px;
  margin: 16px auto;
  max-width: 800px;
  font-size: 1.1rem;
  line-height: 1.6;
  text-align: center;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#desc.speaking {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.error {
  background: #ff4757;
  color: white;
  padding: 12px;
  border-radius: 10px;
  margin: 12px auto;
  max-width: 800px;
  display: none;
  text-align: center;
}

.nav-panel {
  background: #f8f9ff;
  border: 2px solid #e6e8ff;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.nav-panel h3 {
  color: #667eea;
  margin-bottom: 12px;
}

.map-container {
  margin-top: 20px;
}

.map-img {
  width: 100%;
  max-width: 600px;
  border-radius: 12px;
  border: 2px solid #667eea;
  display: block;
  margin: 0 auto;
}

.directions {
  background: white;
  border: 2px solid #e6e8ff;
  border-radius: 12px;
  padding: 16px;
  margin-top: 16px;
}

.directions h4 {
  color: #667eea;
  margin-bottom: 8px;
}

.step {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
}

.step:last-child {
  border-bottom: none;
}

.nearby {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
  margin-top: 16px;
}

.nearby-item {
  background: white;
  border: 1px solid #e6e8ff;
  border-radius: 10px;
  padding: 12px;
}

.nearby-item h5 {
  color: #667eea;
  margin-bottom: 6px;
}

.status {
  text-align: center;
  color: #666;
  font-size: 0.95rem;
  margin-top: 12px;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üß≠ Vision + Navigation Assistant</h1>
    <p>Real-time navigation with AI vision assistance</p>
  </div>

  <div class="content">
    <!-- Destination Input -->
    <div class="input-group">
      <input id="dest" type="text" placeholder="Enter destination (e.g., Starbucks San Jose, CA)">
      <button id="useLoc" class="btn success">üìç Use My Location</button>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button id="startNav" class="btn">üß≠ Start Navigation</button>
      <button id="stopNav" class="btn danger hidden">‚èπÔ∏è Stop Navigation</button>
      <button id="tellMe" class="btn">üó£Ô∏è Tell Me Now</button>
    </div>

    <!-- Status -->
    <div class="status" id="status">Click "Use My Location" to enable GPS, then start navigation</div>

    <!-- Video/Canvas -->
    <div class="media-container">
      <video id="vid" autoplay playsinline></video>
      <canvas id="can"></canvas>
    </div>

    <!-- Description -->
    <div id="desc">Ready to assist you</div>
    <div id="error" class="error"></div>

    <!-- Navigation Panel -->
    <div id="navPanel" class="nav-panel hidden">
      <h3>üìç Current Location</h3>
      <div id="currentLocation"></div>
      
      <!-- Map -->
      <div class="map-container" id="mapContainer" class="hidden">
        <img id="mapImg" class="map-img" alt="Navigation map">
      </div>

      <!-- Directions -->
      <div id="directionsContainer" class="directions hidden">
        <h4>üö∂ Walking Directions</h4>
        <div id="directionsSummary"></div>
        <div id="directionsSteps"></div>
      </div>

      <!-- Nearby Places -->
      <div id="nearbyContainer" class="hidden">
        <h4 style="color: #667eea; margin-top: 20px;">üìç Nearby</h4>
        <div id="nearbyList" class="nearby"></div>
      </div>
    </div>
  </div>
</div>

<script>
// Configuration
const API = 'https://c3hcqo9h7b.execute-api.us-east-1.amazonaws.com/dev/items';

// State
let lat = null;
let lng = null;
let stream = null;
let isNavigating = false;
let navigationInterval = null;

// DOM Elements
const vid = document.getElementById('vid');
const can = document.getElementById('can');
const ctx = can.getContext('2d');
const desc = document.getElementById('desc');
const error = document.getElementById('error');
const status = document.getElementById('status');
const destInput = document.getElementById('dest');
const useLocBtn = document.getElementById('useLoc');
const startNavBtn = document.getElementById('startNav');
const stopNavBtn = document.getElementById('stopNav');
const tellMeBtn = document.getElementById('tellMe');
const navPanel = document.getElementById('navPanel');

// Speech synthesis
let isSpeaking = false;
function speak(text) {
  if (!text || isSpeaking) return;
  isSpeaking = true;
  desc.classList.add('speaking');
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.onend = () => {
    isSpeaking = false;
    desc.classList.remove('speaking');
  };
  speechSynthesis.speak(utterance);
}

// Error handling
function showError(msg) {
  error.textContent = msg;
  error.style.display = 'block';
  console.error(msg);
  setTimeout(() => { error.style.display = 'none'; }, 5000);
}

function updateStatus(msg) {
  status.textContent = msg;
}

// Get user location
useLocBtn.addEventListener('click', () => {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      lat = position.coords.latitude;
      lng = position.coords.longitude;
      updateStatus(`Location captured: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
      document.getElementById('currentLocation').textContent = 
        `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
      navPanel.classList.remove('hidden');
    },
    (err) => {
      showError('Location access denied. Please enable GPS in your browser.');
      console.error(err);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
});

// Start navigation
startNavBtn.addEventListener('click', async () => {
  if (!lat || !lng) {
    showError('Please enable location first');
    return;
  }

  try {
    // Request camera access
    stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        width: { ideal: 1280 }, 
        height: { ideal: 720 },
        facingMode: 'environment'
      }
    });
    
    vid.srcObject = stream;
    await vid.play();
    
    // Wait for video to be ready
    await new Promise((resolve) => {
      if (vid.videoWidth > 0) resolve();
      else vid.onloadedmetadata = resolve;
    });

    isNavigating = true;
    startNavBtn.classList.add('hidden');
    stopNavBtn.classList.remove('hidden');
    updateStatus('Navigation active - analyzing surroundings...');
    
    // Start navigation loop
    loop();
    
  } catch (err) {
    showError('Camera access denied: ' + err.message);
    console.error(err);
  }
});

// Stop navigation
stopNavBtn.addEventListener('click', () => {
  stopNavigation();
});

function stopNavigation() {
  isNavigating = false;
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  vid.srcObject = null;
  
  if (navigationInterval) {
    clearTimeout(navigationInterval);
    navigationInterval = null;
  }
  
  startNavBtn.classList.remove('hidden');
  stopNavBtn.classList.add('hidden');
  updateStatus('Navigation stopped');
  desc.textContent = 'Ready to assist you';
}

// Tell me now button
tellMeBtn.addEventListener('click', async () => {
  if (!stream || !vid.videoWidth) {
    showError('Please start navigation first');
    return;
  }
  await captureAndAnalyze(true);
});

// Main navigation loop
async function loop() {
  if (!isNavigating || !stream) return;

  try {
    await captureAndAnalyze(false);
  } catch (err) {
    console.error('Loop error:', err);
  }

  // Continue loop every 3 seconds
  if (isNavigating) {
    navigationInterval = setTimeout(loop, 3000);
  }
}

// Capture frame and analyze
async function captureAndAnalyze(tellMode = false) {
  if (!vid.videoWidth || !vid.videoHeight) {
    console.warn('Video not ready');
    return;
  }

  // Set canvas dimensions
  can.width = vid.videoWidth;
  can.height = vid.videoHeight;
  
  // Draw current frame
  ctx.drawImage(vid, 0, 0, can.width, can.height);
  
  // Get base64 image with higher quality
  const b64 = can.toDataURL('image/jpeg', 0.95);
  
  // Validate base64
  if (!b64 || b64.length < 1000) {
    console.error('Invalid canvas data');
    return;
  }

  const destination = destInput.value.trim();

  // Prepare payload
  const payload = {
    image: b64,
    latitude: lat,
    longitude: lng,
    destination_address: destination || undefined,
    getRoute: !!destination,
    findNearby: true,
    continuous: !tellMode,
    tell: tellMode
  };

  try {
    const response = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    const data = await response.json();
    
    // Handle AI description
    if (data.aiDescription) {
      desc.textContent = data.aiDescription;
      speak(data.aiDescription);
    } else if (data.alert && data.alert.level !== 'none') {
      desc.textContent = data.alert.message;
      speak(data.alert.message);
    }

    // Draw bounding boxes on canvas
    if (data.boundingBoxes && data.boundingBoxes.length > 0) {
      can.style.display = 'block';
      vid.style.display = 'none';
      drawBoundingBoxes(data.boundingBoxes);
    }

    // Handle navigation data
    if (data.maps) {
      renderNavigation(data.maps);
      
      // Speak first direction if available
      if (data.maps.route && data.maps.route.steps && data.maps.route.steps.length > 0) {
        const firstStep = data.maps.route.steps[0];
        speak(firstStep.instruction);
      }
    }

  } catch (err) {
    showError('API Error: ' + err.message);
    console.error('API call failed:', err);
  }
}

// Draw bounding boxes on canvas
function drawBoundingBoxes(boxes) {
  boxes.forEach((box, i) => {
    const color = `hsl(${(i * 67) % 360}, 70%, 50%)`;
    const x = box.box.left * can.width;
    const y = box.box.top * can.height;
    const w = box.box.width * can.width;
    const h = box.box.height * can.height;
    
    // Draw box
    ctx.lineWidth = 3;
    ctx.strokeStyle = color;
    ctx.strokeRect(x, y, w, h);
    
    // Draw label
    const label = `${box.label} ${Math.round(box.confidence)}%`;
    ctx.font = 'bold 16px Arial';
    const textWidth = ctx.measureText(label).width + 10;
    
    ctx.fillStyle = color;
    ctx.fillRect(x, Math.max(0, y - 25), textWidth, 25);
    
    ctx.fillStyle = '#fff';
    ctx.fillText(label, x + 5, Math.max(18, y - 7));
  });
}

// Render navigation information
function renderNavigation(maps) {
  // Display map image
  if (maps.map_url) {
    document.getElementById('mapImg').src = maps.map_url;
    document.getElementById('mapContainer').classList.remove('hidden');
  }

  // Display directions
  if (maps.route) {
    const dirContainer = document.getElementById('directionsContainer');
    const dirSummary = document.getElementById('directionsSummary');
    const dirSteps = document.getElementById('directionsSteps');
    
    dirContainer.classList.remove('hidden');
    dirSummary.innerHTML = `
      <strong>${maps.route.total_distance}</strong> ‚Ä¢ 
      <strong>${maps.route.total_duration}</strong>
    `;
    
    dirSteps.innerHTML = '';
    maps.route.steps.forEach((step, i) => {
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step';
      stepDiv.innerHTML = `
        <strong>${i + 1}.</strong> ${step.instruction} 
        <span style="color: #999;">(${step.distance}, ${step.duration})</span>
      `;
      dirSteps.appendChild(stepDiv);
    });
  }

  // Display nearby places
  if (maps.nearby) {
    const nearbyContainer = document.getElementById('nearbyContainer');
    const nearbyList = document.getElementById('nearbyList');
    
    nearbyList.innerHTML = '';
    let hasNearby = false;
    
    ['hospitals', 'police', 'transit'].forEach(type => {
      if (maps.nearby[type] && maps.nearby[type].length > 0) {
        hasNearby = true;
        maps.nearby[type].forEach(place => {
          const placeDiv = document.createElement('div');
          placeDiv.className = 'nearby-item';
          
          const typeLabel = type === 'hospitals' ? 'üè• Hospital' : 
                          type === 'police' ? 'üöî Police' : 
                          'üöá Transit';
          
          const rating = place.rating ? `‚≠ê ${place.rating}` : '';
          const openStatus = place.open_now === true ? '‚úÖ Open' : 
                           place.open_now === false ? 'üî¥ Closed' : '';
          const distance = place.distance ? `${Math.round(place.distance)}m away` : '';
          
          placeDiv.innerHTML = `
            <h5>${typeLabel}</h5>
            <div><strong>${place.name}</strong></div>
            <div style="font-size: 0.9rem; color: #666;">
              ${place.address || 'Address unavailable'}<br>
              ${rating} ${openStatus} ${distance}
            </div>
          `;
          nearbyList.appendChild(placeDiv);
        });
      }
    });
    
    if (hasNearby) {
      nearbyContainer.classList.remove('hidden');
    }
  }

  // Update current location address
  if (maps.location && maps.location.address) {
    document.getElementById('currentLocation').textContent = 
      `üìç ${maps.location.address}`;
  }
}

// Initialize
updateStatus('Click "Use My Location" to enable GPS');

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  stopNavigation();
});
</script>
</body>
</html>